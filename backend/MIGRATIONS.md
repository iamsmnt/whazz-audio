# Database Migrations - Quick Reference

This document provides a quick reference for database migrations using Alembic.

## Setup

### First Time Setup

```bash
# 1. Initialize Alembic
./init_alembic.sh

# 2. Create initial migration
./migrate.sh init

# 3. Apply migrations to database
./migrate.sh upgrade
```

## Common Commands

### Using Helper Scripts (Recommended)

| Command | Description |
|---------|-------------|
| `./migrate.sh init` | Create initial migration |
| `./migrate.sh create "message"` | Create new migration |
| `./migrate.sh upgrade` | Apply all pending migrations |
| `./migrate.sh downgrade` | Rollback one migration |
| `./migrate.sh current` | Show current version |
| `./migrate.sh history` | Show migration history |
| `./migrate.sh reset` | Rollback all migrations |

### Using Alembic Directly

| Command | Description |
|---------|-------------|
| `alembic revision --autogenerate -m "message"` | Create new migration |
| `alembic upgrade head` | Apply all migrations |
| `alembic upgrade +1` | Apply next migration |
| `alembic downgrade -1` | Rollback one migration |
| `alembic downgrade base` | Rollback all migrations |
| `alembic downgrade <revision>` | Downgrade to specific revision |
| `alembic current` | Show current revision |
| `alembic history` | Show migration history |
| `alembic history --verbose` | Show detailed history |
| `alembic show <revision>` | Show specific revision |
| `alembic stamp head` | Mark database as current |

## Development Workflow

### 1. Make Model Changes

Edit your models in `models.py`:

```python
# Add a new field
class User(Base):
    # ... existing fields ...
    phone_number = Column(String, nullable=True)
```

### 2. Create Migration

```bash
./migrate.sh create "Add phone number to User"
```

This generates a new migration file in `alembic/versions/`.

### 3. Review Migration

Open the generated file and verify the changes:

```python
def upgrade() -> None:
    # Check that this matches your intended changes
    op.add_column('users', sa.Column('phone_number', sa.String(), nullable=True))

def downgrade() -> None:
    # Check the rollback logic
    op.drop_column('users', 'phone_number')
```

### 4. Apply Migration

```bash
./migrate.sh upgrade
```

### 5. Verify

```bash
# Check current version
./migrate.sh current

# Or connect to database
psql -U postgres whazz_audio -c "\d users"
```

## Migration Best Practices

### DO

✅ **Always review autogenerated migrations** before applying
✅ **Test migrations on development database** first
✅ **Keep migrations in version control**
✅ **Write descriptive migration messages**
✅ **Make small, focused migrations**
✅ **Test both upgrade and downgrade**
✅ **Add data migrations when needed**

### DON'T

❌ **Don't edit applied migrations** (create a new one instead)
❌ **Don't skip testing migrations**
❌ **Don't combine unrelated changes** in one migration
❌ **Don't delete migration files** that have been applied
❌ **Don't trust autogenerate 100%** (some changes require manual migration)

## Common Scenarios

### Adding a Column

```python
# models.py
class User(Base):
    bio = Column(Text, nullable=True)
```

```bash
./migrate.sh create "Add bio to User"
./migrate.sh upgrade
```

### Adding a Required Column

```python
# models.py
class User(Base):
    # New required field - need default for existing rows
    full_name = Column(String, nullable=False, server_default='')
```

```bash
./migrate.sh create "Add full_name to User"
# Review and modify migration to handle existing data
./migrate.sh upgrade
```

### Renaming a Column (Manual Migration)

```bash
# Create empty migration
alembic revision -m "Rename username to user_name"

# Edit the migration file:
# def upgrade():
#     op.alter_column('users', 'username', new_column_name='user_name')
#
# def downgrade():
#     op.alter_column('users', 'user_name', new_column_name='username')

./migrate.sh upgrade
```

### Adding an Index

```python
# models.py
class User(Base):
    email = Column(String, unique=True, index=True)  # Add index=True
```

```bash
./migrate.sh create "Add index to email"
./migrate.sh upgrade
```

### Data Migration

Sometimes you need to migrate data along with schema changes:

```python
# In the migration file
from alembic import op
import sqlalchemy as sa

def upgrade():
    # Add new column
    op.add_column('users', sa.Column('is_premium', sa.Boolean(), nullable=True))

    # Migrate data
    connection = op.get_bind()
    connection.execute(
        sa.text("UPDATE users SET is_premium = false WHERE is_premium IS NULL")
    )

    # Make column non-nullable
    op.alter_column('users', 'is_premium', nullable=False)

def downgrade():
    op.drop_column('users', 'is_premium')
```

## Troubleshooting

### Migration Fails

```bash
# Check current state
./migrate.sh current

# See what went wrong
./migrate.sh history

# Rollback if needed
./migrate.sh downgrade
```

### Conflicts in Migrations

If you have multiple branches with migrations:

```bash
# Check migration history
alembic history

# Merge heads if needed
alembic merge -m "Merge migration branches" <revision1> <revision2>
```

### Reset Database

If you need to start fresh:

```bash
# Rollback all migrations
./migrate.sh reset

# Drop and recreate database
dropdb -U postgres whazz_audio
createdb -U postgres whazz_audio

# Reapply all migrations
./migrate.sh upgrade
```

### Mark Database as Current (Without Running Migrations)

If you manually modified the database:

```bash
alembic stamp head
```

## Production Deployment

### Pre-deployment

1. **Backup database** before applying migrations
2. **Test migrations** on staging environment
3. **Review all pending migrations**
4. **Plan rollback strategy**

### Deployment

```bash
# On production server
cd backend
source venv/bin/activate

# Check current version
alembic current

# See pending migrations
alembic history

# Apply migrations
alembic upgrade head

# Verify
alembic current
```

### Rollback

```bash
# Rollback last migration
alembic downgrade -1

# Rollback to specific version
alembic downgrade <revision_id>
```

## File Structure

```
backend/
├── alembic/
│   ├── versions/           # Migration files
│   │   ├── abc123_initial_migration.py
│   │   └── def456_add_user_fields.py
│   ├── env.py             # Alembic environment config
│   └── script.py.mako     # Migration template
├── alembic.ini            # Alembic configuration
├── init_alembic.sh        # Setup script
└── migrate.sh             # Helper script
```

## Additional Resources

- [Alembic Documentation](https://alembic.sqlalchemy.org/)
- [SQLAlchemy Documentation](https://docs.sqlalchemy.org/)
- [PostgreSQL Documentation](https://www.postgresql.org/docs/)
